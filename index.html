<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>

  <title>Haags kind</title>

  <script src='../d3/d3.js' type='text/javascript'></script>
  <script src='assets/js/crossfilter.js' type='text/javascript'></script>
  <script src='assets/js/dc.js' type='text/javascript'></script>
  <script src='assets/js/jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='assets/js/bootstrap.min.js' type='text/javascript'></script>

  <link href='assets/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='assets/css/dc.css' rel='stylesheet' type='text/css'>

  <style type="text/css"></style>
</head>

<body>

<div class='container' id='main-container'>
<div class='content'>
<div class='container' style='font: 12px sans-serif;'>

  <div class='row'>
    <div class='span12'>
      <h3>Weight and Length Haagse children</h3>
      <div class='row'>
        <div class='pie-graph span6' id='dc-bubble-chart'>
        <h4>Height and weight</h4>
        </div>
        <div class='pie-graph span6' id='dc-geo-chart'>
        <h4>Map of The Hague</h4>
        </div>    
      </div>
    </div>
  </div>

  <div class='row'>
    <div class='span12' id='dc-bmi-bar-chart'>
      <h4>Children by BMI</h4>
    </div>
  </div>

  <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='span3' id='dc-gender-chart'>
        <h4>Gender</h4>
        </div>
        <div class='span3' id='dc-ethnicity-chart'>
        <h4>Ethnicity</h4>
        </div>    
        <div class='span3' id='dc-age-chart'>
        <h4>Age</h4>
        </div>
        <div class='span3' id='dc-year-chart'>
        <h4>Assessment Year</h4>
        </div>    
      </div>      
    </div>
  </div>

  <div class='row'>
  <div class='pie-graph span12'>
      <table class='table table-hover' id='dc-table-graph'>
        <thead>
          <tr class='header'>
            <th>Gender</th>
            <th>Ethnicity</th>
            <th>Age</th>
            <th>Height</th>
            <th>Weight</th>
            <th>BMI</th>
            <th>CBS district</th>
            <th>Assessment Year</th>
          </tr>
        </thead>
      </table>
  </div>
  </div>

<H5>Generated with 
  <a href="http://nickqizhu.github.io/dc.js/">dc.js</a>,
  <a href="http://square.github.io/crossfilter/">crossfilter</a>, 
  <a href="http://d3js.org/">d3.js</a> and 
  <a href="http://twitter.github.io/bootstrap/">bootstrap</a>.
</H5>
<p>Data via <a href="https://beta.columby.com/explore/dataset/349">Columby</a>.</p>

</div>
</div>
</div>
  
<script>

// load data from a csv file
d3.csv("data/data.csv", function (data) {
  
  data.forEach(function(d) {
    d.age = +d.age;
    d.year_assessment = +d.year_assessment;
    d.height = +d.height;
    d.weight = +d.weight;
    d.bmi = d3.round(d.weight/((d.height*d.height)/10000),1);
  });

  var geoChart = dc.geoChoroplethChart("#dc-geo-chart");
  var bmiBarChart = dc.barChart("#dc-bmi-bar-chart");
  var genderChart = dc.rowChart("#dc-gender-chart");
  var ethnicityChart = dc.rowChart("#dc-ethnicity-chart");
  var ageChart = dc.barChart("#dc-age-chart");
  var yearChart = dc.barChart("#dc-year-chart");
  var dataTable = dc.dataTable("#dc-table-graph");

  var facts = crossfilter(data);  // Gets our 'facts' into crossfilter

  /******************************************************
  * Create the Dimensions                               *
  ******************************************************/

  // for Choropleth
  var districtValue = facts.dimension(function (d) {return d.cbs_wijkcode; });
  var districtValueGroupCount = districtValue.group()
    .reduceCount(function(d) { return d.cbs_wijkcode; }); 

  // for BMI
  var bmiValue = facts.dimension(function (d) {return d.bmi;}); // group or filter by BMI
  var bmiValueGroupSum = bmiValue.group()
    .reduceSum(function(d) { return d.bmi; });  // sums the measurements per BMI (rounded to 1 decimal)
  var bmiValueGroupCount = bmiValue.group()
    .reduceCount(function(d) { return d.bmi; }) // counts the number of the measurements by BMI

  // for gender
  var genderValue = facts.dimension(function (d) {return d.gender; }) 
  var genderGroupCount = genderValue.group()
    .reduceCount(function(d) {return d.gender; })

  // for ethnicity
  var ethnicityValue = facts.dimension(function (d) {return d.ethnicity; }) 
  var ethnicityGroupCount = ethnicityValue.group()
    .reduceCount(function(d) {return d.ethnicity; })

  // for age
  var ageValue = facts.dimension(function (d) {return d.age; }) 
  var ageGroupSum = ageValue.group()
    .reduceSum(function(d) {return d.bmi; })
  var ageGroupCount = ageValue.group()
    .reduceCount(function(d) {return d.bmi })

  // for Assessment Year
  var yearValue = facts.dimension(function (d) {return d.year_assessment; }) 
  var yearGroupCount = yearValue.group()
    .reduceCount(function(d) {return d.year_assessment; })

  // Create dataTable dimension
  var genderDimension = facts.dimension(function (d) {
    return d.gender;
  });

  /***************************************
  *   Create the Visualisations   *
  ***************************************/

  d3.json("geo/denhaag.json", function (districts) {
      geoChart.width(480)
        .height(400)
        .dimension(districtValue)
        .group(districtValueGroupCount)
        .projection(d3.geo.mercator()
                    .scale(103864)
                    .translate([ -7570, 111130 ])
                    )
        .colors(d3.scale
                  .quantize()
                  .range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"])
                )
        .colorDomain([0, 20000])
        .colorCalculator(function (d) { return d ? geoChart.colors()(d) : '#ccc'; })
        .overlayGeoJson(districts.features, "district", function (d) {
            return d.properties.WK_CODE;
        })
        .title(function (d) {
            return "District: " + d.key;
        });

      // BMI Bar Chart Summed
      bmiBarChart.width(960)
        .height(150)
        .margins({top: 10, right: 10, bottom: 20, left: 40})
        .dimension(bmiValue) // the values across the x axis
        .group(bmiValueGroupCount) // the values on the y axis
      .transitionDuration(500)
        .centerBar(true)  
      .gap(21) // bar width Keep increasing to get right then back off.
        .x(d3.scale.linear().domain(d3.extent(data, function(d) { return d.bmi; })))
      .elasticY(true)
      .xAxis().tickFormat(function(v) {return v;}); 

      var rowMargins = {top: 5, left: 30, right: 20, bottom: 40}

      // Gender Row Chart
      genderChart.width(240)
        .height(220)
        .margins(rowMargins)
        .dimension(genderValue)
        .group(genderGroupCount)
        .colors(['#79AACD', '#FD9CA7'])
        // .elasticX(true)
        .xAxis().ticks(4);

      // Ethnicity Row Chart
      ethnicityChart.width(240)
        .height(220)
        .margins(rowMargins)
        .dimension(ethnicityValue)
        .group(ethnicityGroupCount)
        // .elasticX(true)
        .xAxis().ticks(4);

      // Age Bar Chart
      ageChart.width(240)
        .height(220)
        .margins(rowMargins)
        .dimension(ageValue)
        .group(ageGroupSum)
        .centerBar(true)
        .gap(5)
        .x(d3.scale.linear().domain(d3.extent(data, function(d) { return d.age; })))
        .elasticY(true)
        .xAxis().tickFormat(function(v) {return v;}); 


      // Assessment Year Bar Chart
      yearChart.width(240)
        .height(220)
        .margins(rowMargins)
        .dimension(yearValue)
        .group(yearGroupCount)
        .centerBar(true)  
        .gap(10)
        .x(d3.scale.linear().domain(d3.extent(data, function(d) { return d.year_assessment; })))
        .elasticY(true)
        .xAxis().tickFormat(function(v) {return v;}); 

      // Table with the data
      dataTable.width(960).height(800)
        .dimension(genderDimension)
      .group(function(d) { return "List of all data corresponding to the filters"
       })
      .size(10)             // number of rows to return
        .columns([
          function(d) { return d.gender; },
          function(d) { return d.ethnicity; },
          function(d) { return d.age; },
          function(d) { return d.height; },
          function(d) { return d.weight; },
          function(d) { return d.bmi; },
          function(d) { return d.cbs_wijkcode; },      
          function(d) { return d.year_assessment; }
        ])
        .sortBy(function(d){ return d.gender; })
        .order(d3.ascending);

    /****************************
    * Step6: Render the Charts  *
    ****************************/
          
      dc.renderAll();


      });

  
});
  
</script>
    
</body>
</html>
